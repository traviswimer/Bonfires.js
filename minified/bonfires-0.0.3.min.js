/* Bonfires v0.0.3 | (c) 2013 Travis Wimer - http://traviswimer.com | Released under the MIT license */
var channelsArray,allSignalings=[];!function(){"use strict";channelsArray=[];var a=function(a,c){function d(a,b){if(!a)throw new Error("Bonfire Err: You must specify a DataChannel");if("object"!=typeof a)throw new Error("Bonfire Err: Invalid DataChannel");if(!b)throw new Error("Bonfire Err: You must include an options object");if("object"!=typeof b)throw new Error("Bonfire Err: Invalid options")}function e(a,c){var d;if(a&&"undefined"!==a){try{d=JSON.parse(a)}catch(h){return k(h),void 0}switch(d.type){case"serverRequestingOffer":console.log("Signaler is requesting a connection offer to send to another peer"),f(d.peerId,d.data);break;case"peerRequest":console.log("Signaler received peer request from initiator");var i=d.peerId,j=m(d.data)||!1;if(j){q[i]=b(j,e,"responder",d.peerId);var l={peerId:i,type:"serverRequestingOffer"};q[d.peerId].send(l,d.peerId)}break;case"clientSendingOffer":if(console.log("Signaler received a connection offer from the responding peer"),d.peerId){var n={peerId:d.peerId,type:"serverSendingOffer",offer:d.offer};s.send(n,d.peerId)}break;case"clientSendingAnswer":if(console.log("Signaler received a connection answer from the initiating peer"),d.peerId){var o={peerId:d.peerId,type:"serverSendingAnswer",answer:d.answer};"undefined"!=typeof q[d.peerId]&&q[d.peerId].send(o)}break;case"clientSendingIce":"initiator"===c?"undefined"!=typeof q[d.peerId]&&g(q[d.peerId],d):g(s,d);break;default:if(d.peerId&&p[d.peerId]){var r=p[d.peerId];r.receive(d)}}}}function f(a,b){var c=h(a);n(c,b,function(){var b={peerId:a,type:"serverRequestingOffer"};c.receive(b)}),c.receive({type:"connect"})}function g(a,b){try{var c={peerId:b.peerId,type:"serverSendingIce",candidate:b.candidate};a.send(c)}catch(d){k(d)}}function h(a){function b(a,b){b.type=a;var c=b;try{s.send(c)}catch(d){setTimeout(s.send,500,c)}}function c(a,b){f[a]?f[a].push(b):f[a]=[b]}function d(a){var b=f[a.type];if(b&&b.length)for(var c=0;c<b.length;c++)b[c](a)}function e(){return a}a=a||i();var f={};return p[a]={emit:b,on:c,receive:d,getPeerId:e},p[a]}function i(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;5>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}function j(a){var b=h();o(b,a,function(){var c={peerId:b.getPeerId(),type:"peerRequest",data:a};s.send(c)}),b.receive({type:"connect"})}function k(a){setTimeout(function(){throw a},0)}try{d(a,c)}catch(l){return k(l),!1}var m=c.onSignalingRequest||function(){k(new Error("Bonfire Err: onSignalingRequest was never defined"))},n=c.respondingConnector||function(){k(new Error("Bonfire Err: respondingConnector was never defined"))},o=c.initiatingConnector||function(){k(new Error("Bonfire Err: initiatingConnector was never defined"))},p={},q={};allSignalings.push(q);var r=i(),s=b(a,e,"initiator",r);return{requestPeer:j}};window.bonfire=a;var b=function(a,b,c,d){function e(a){var b=a.data,c=f(b),d=c.type,e="";switch(A.push(c),"waiting"===w&&(clearInterval(z),w="setup",l()),d){case"message":if(e=c.message,y[c.messageId]||(y[c.messageId]={}),!y[c.messageId][c.chunkId]){var h=setInterval(function(a,b){i(a,b,c.peerId)},2e3,c.messageId,c.chunkId);y[c.messageId][c.chunkId]={data:c.message,interval:h,state:"sending"},c.isEnd&&n(c.messageId,c.chunkId,c.peerId),i(c.messageId,c.chunkId,c.peerId)}break;case"ack":"message"===x[c.messageId][c.chunkId].state&&(x[c.messageId][c.chunkId].state="received",clearInterval(x[c.messageId][c.chunkId].interval)),g(c.messageId,c.chunkId,c.peerId);break;case"back":"sending"===y[c.messageId][c.chunkId].state&&(y[c.messageId][c.chunkId].state="acknowledged",clearInterval(y[c.messageId][c.chunkId].interval))}}function f(a){var b=a.indexOf("-"),c=a.substr(0,b);a=a.substr(b+1);var d=/^([0-9]+)-([0-9]+):(.+)/,e=d.exec(a);if(e)return{type:"message",peerId:c,messageId:e[1],chunkId:e[2],message:e[3]};var f=/^([0-9]+)-([0-9]+)a/,g=f.exec(a);if(g){var h=m(a);return h>v&&(v=h),{type:"ack",peerId:c,messageId:g[1],chunkId:g[2]}}var i=/^([0-9]+)-([0-9]+)b/,j=i.exec(a);if(j)return{type:"back",peerId:c,messageId:j[1],chunkId:j[2]};var k=/^([0-9]+)-([0-9]+)!/,l=k.exec(a);return l?{type:"message",peerId:c,messageId:l[1],chunkId:l[2],isEnd:!0}:{type:null}}function g(a,b,c){var d=x[a][b],e="";switch(d.state){case"message":e=c+"-"+a+"-"+b+":"+d.data;break;case"received":e=c+"-"+a+"-"+b+"b"}o(e)}function h(a,b,c){x[a][b];var d=c+"-"+a+"-"+b+"!";o(d)}function i(a,b,c){y[a][b];var d=c+"-"+a+"-"+b+"a";try{o(d)}catch(e){}}function j(a,b,c){for(var d=[],e="",f="";a.length>0;){f=a.substr(0,1),a=a.slice(1);var g=c+"-"+d.length+":"+e+f;m(g)<=b?e+=f:(d.push(e),e=f)}return e&&e.length>0&&d.push(e),d}function k(){"open"===a.readyState&&(clearInterval(z),w="setup",l())}function l(){v=1e3}function m(a){return encodeURI(a).split(/%..|./).length-1}function n(a,d,e){var f=Object.keys(y[a]).length-1;if(d=1*d,f!==d)setTimeout(n,1e3,a,d,e);else{for(var g="",h=0;f>h;h++)g+=y[a][h].data;s[e]||q(e,b,c),s[e].handler(g,s[e].peerType)}}function o(b){try{a.send(b)}catch(c){}}function p(a,b){b=b||a.peerId;var c=JSON.stringify(a),d=u++,e=j(c,v,d);x[d]={};for(var f=0;f<e.length;f++)!function(a,c,d){var e=setInterval(function(a,c){g(a,c,b)},2e3,a,c);x[a][c]={state:"message",data:d[c],interval:e},g(a,c,b)}(d,f,e);var i=e.length,k=setInterval(function(a,c){h(a,c,b)},2e3,d,i);x[d][i]={state:"message",interval:k},h(d,i,b)}function q(a,b,c){s[a]={},s[a].handler=b,s[a].peerType=c}for(var r=0;r<channelsArray.length;r++)if(channelsArray[r].channel===a)return channelsArray[r].addPeer(d,b,c),channelsArray[r];var s={},t={addPeer:q,channel:a,getState:function(){return w},send:p,peersHolder:s},u=0,v=10,w="waiting",x={},y={},z=setInterval(k,500),A=[];return setInterval(function(){0!==A.length&&(A=[])},3e3),a.onmessage=e,channelsArray.push(t),t.addPeer(d,b,c),t}}();